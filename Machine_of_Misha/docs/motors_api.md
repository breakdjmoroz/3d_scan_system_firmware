# motors_api.md

## 1. Общее описание назначения кода
Модуль `motors_api` предоставляет низкоуровневый API для управления шаговыми двигателями через драйверы. Реализует базовые операции: управление питанием, направлением вращения и генерацию шаговых импульсов. Поддерживает различные режимы микрошага (STEP_MODE) для разных типов драйверов.

## 2. API модуля

### Класс Motor
```cpp
class Motor {
public:
    const STEP_MODE _STEPS_IN_FULL_ROTATION; // Количество шагов на полный оборот для текущего режима

    // Конструктор: инициализация пинов управления и режима шага
    Motor(size_t ena_pin, size_t dir_pin, size_t pul_pin, STEP_MODE step_mode);
    
    // Настройка пинов и начального состояния двигателя
    void set_up();
    
    // Включение питания двигателя (активный уровень)
    void enable();
    
    // Отключение питания двигателя
    void disable();
    
    // Выполнение одного шага (полного цикла импульса)
    void step();
    
    // Установка направления вращения по часовой стрелке
    void clockwise_dir();
    
    // Установка направления вращения против часовой стрелки
    void counterclockwise_dir();
    
    // Инверсия текущего направления вращения
    void inverse_dir();
};
```

### Пользовательские типы данных
```cpp
enum STEP_MODE {
    STEP_1    = 200,     // Полный шаг (200 шагов/оборот)
    STEP_2_A  = 400,     // Полушаг (режим A)
    STEP_2_B  = 400,     // Полушаг (режим B)
    STEP_4    = 800,     // 1/4 шага
    STEP_8    = 1600,    // 1/8 шага
    STEP_16   = 3200,    // 1/16 шага
    STEP_32   = 6400,    // 1/32 шага
    STEP_NEMA = 33152,   // Специальный режим для NEMA-мотора сканера
    STEP_57HS100 = 25600 // Режим для мотора 57HS100 (стола)
};
```

## 3. Подробное описание функций

### `Motor::Motor(size_t ena_pin, size_t dir_pin, size_t pul_pin, STEP_MODE step_mode)`
- **Назначение**: Создает объект для управления шаговым двигателем
- **Параметры**:
  - `ena_pin`: Пин включения двигателя (ENABLE)
  - `dir_pin`: Пин направления (DIRECTION)
  - `pul_pin`: Пин шага (PULSE)
  - `step_mode`: Режим микрошага из enum STEP_MODE
- **Примечание**: Не активирует физические пины до вызова set_up()

### `void Motor::set_up()`
- **Назначение**: Инициализирует аппаратные пины и базовую конфигурацию
- **Действия**:
  - Настраивает указанные пины на выход (OUTPUT)
  - Включает двигатель (enable())
  - Устанавливает направление по часовой стрелке
- **Вызов**: Требуется однократный вызов перед использованием двигателя

### `void Motor::enable()`
- **Назначение**: Подает питание на обмотки двигателя
- **Эффект**: Двигатель переходит в рабочее состояние с удержанием позиции
- **Примечание**: Использует активный уровень ENABLE_MOTOR (обычно LOW)

### `void Motor::disable()`
- **Назначение**: Отключает питание обмоток двигателя
- **Эффект**: Двигатель перестает удерживать позицию, снижается энергопотребление
- **Примечание**: Не влияет на текущее направление вращения

### `void Motor::step()`
- **Назначение**: Выполняет один полный шаговый импульс
- **Алгоритм**:
  1. Устанавливает PUL пин в HIGH
  2. Ждет PERIOD/2 микросекунд
  3. Устанавливает PUL пин в LOW
  4. Ждет PERIOD/2 микросекунд
- **Частота**: Определяется MAX_FREQUENCY (200 кГц)

### `void Motor::clockwise_dir()`
- **Назначение**: Устанавливает направление вращения "по часовой стрелке"
- **Реализация**: Устанавливает DIR пин в DIR_CLOCKWISE (0)
- **Задержка**: Добавляет WAIT_INTERVAL (5 мкс) перед изменением направления

## 4. Пример программы
```cpp
#include "motors_api.h"

// Конфигурация пинов
#define ENA_PIN 8
#define DIR_PIN 9
#define PUL_PIN 10

// Создание объекта мотора в режиме 1/8 шага
Motor motor(ENA_PIN, DIR_PIN, PUL_PIN, STEP_8);

void setup() {
    motor.set_up(); // Обязательная инициализация
}

void loop() {
    // Вращение по часовой стрелке (200 шагов = 1 оборот в режиме полного шага)
    motor.clockwise_dir();
    for (int i = 0; i < 200; i++) {
        motor.step();
        delay(10); // Задержка для снижения скорости
    }
    
    // Вращение против часовой стрелки
    motor.counterclockwise_dir();
    for (int i = 0; i < 200; i++) {
        motor.step();
        delay(10);
    }
    
    motor.disable(); // Отключение питания
    delay(1000);
    motor.enable();  // Включение питания
}
```
